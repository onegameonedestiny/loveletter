import React, { useState, useEffect, useMemo } from 'react';
import { Mail, Send, User, Moon, Heart, RefreshCw, LogIn, AlertCircle, CheckCircle, Users, Cat, X, ChevronRight, WifiOff } from 'lucide-react';

const GAS_URL = "https://script.google.com/macros/s/AKfycbxy-gnJHmXgei_k68l0wN15wzaOyel6ya4LhsPj3i3yrtGgY3BsCqJ5YLBzaOn6olOV/exec";

const App = () => {
  const [user, setUser] = useState({ id: "", stage: "1" });
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [loading, setLoading] = useState(false);
  const [data, setData] = useState(null);
  const [notification, setNotification] = useState(null);
  
  // New State: Critical Connection Error
  const [connectionError, setConnectionError] = useState(false);
  
  // New state for Inbox Modal
  const [showInbox, setShowInbox] = useState(false);
  
  // New State: Client-side new mail counter
  const [newMailCount, setNewMailCount] = useState(0);

  // Helper to show notifications
  const showNotification = (message, type = 'success') => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 3000);
  };

  // Login Handler
  const handleLogin = (e) => {
    e.preventDefault();
    if (!user.id) {
      showNotification("è«‹è¼¸å…¥ ID", "error");
      return;
    }
    setLoading(true);
    // ç›´æ¥å‘¼å«ï¼Œä¸å†ä½¿ç”¨ Promise.all ç­‰å¾…å‹•ç•«ï¼Œä»¥æ±‚æœ€å¿«åæ‡‰
    fetchData(user.id, user.stage);
  };

  // Fetch Data from GAS
  const fetchData = async (userId, stage) => {
    try {
      // è¨­å®šä¸€å€‹ 15 ç§’çš„ timeoutï¼Œé¿å…ç€è¦½å™¨ç„¡é™æœŸç­‰å¾…å°è‡´"å¡ä½50å¹¾ç§’"
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000);

      const response = await fetch(`${GAS_URL}?userID=${userId}&stage=${stage}`, {
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      
      if (result.error) throw new Error(result.error);
      
      setData(result);
      setIsLoggedIn(true);
      setConnectionError(false); // Reset error if successful
    } catch (err) {
      console.error("Critical API Fetch failed:", err);
      // ç™¼ç”ŸéŒ¯èª¤ç›´æ¥é€²å…¥éŒ¯èª¤ç•«é¢
      setConnectionError(true);
    } finally {
      setLoading(false);
    }
  };

  // Auto-login Effect: Check URL parameters on mount
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    // æ”¯æ´ userID æˆ– id åƒæ•¸
    const urlID = params.get('userID') || params.get('id');
    const urlStage = params.get('stage');

    if (urlID) {
      const targetStage = urlStage || "1";
      // æ›´æ–°ä½¿ç”¨è€…ç‹€æ…‹
      setUser({ id: urlID, stage: targetStage });
      // è¨­å®šè¼‰å…¥ä¸­ä¸¦ç›´æ¥ç²å–è³‡æ–™
      setLoading(true);
      fetchData(urlID, targetStage);
    }
  }, []); // Empty dependency array ensures this runs only once on mount

  // Logic: Check LocalStorage for new mail count when data changes
  useEffect(() => {
    if (data && data.inbox && user.id) {
        const storageKey = `moon_last_count_${user.id}`;
        const lastCount = parseInt(localStorage.getItem(storageKey) || '0', 10);
        const currentCount = data.inbox.length;

        if (currentCount > lastCount) {
            setNewMailCount(currentCount - lastCount);
        } else {
            setNewMailCount(0);
        }
    }
  }, [data, user.id]);

  // Handle Opening Inbox (Update Local Storage)
  const handleOpenInbox = () => {
    setShowInbox(true);
    if (data && data.inbox && user.id) {
        const storageKey = `moon_last_count_${user.id}`;
        localStorage.setItem(storageKey, data.inbox.length.toString());
        setNewMailCount(0);
    }
  };

  // Send Letter Handler
  const handleSend = async (targetId, sentence) => {
    setLoading(true);
    try {
      const response = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({ 
          stage: user.stage, 
          senderID: user.id, 
          targetID: targetId, 
          sentence: sentence 
        })
      });
      const result = await response.json();
      if (result.status === "success") {
        showNotification("ä¿¡ä»¶å·²æˆåŠŸå¯„å‡ºï¼");
        fetchData(user.id, user.stage);
      } else {
        throw new Error(result.msg || "å¯„é€å¤±æ•—");
      }
    } catch (err) {
      showNotification(err.message, "error");
    } finally {
      setLoading(false);
    }
  };

  // CRITICAL: Connection Error Screen
  // æ­¤ç‹€æ…‹å„ªå…ˆç´šæœ€é«˜ï¼Œä¸€æ—¦é€£ç·šå¤±æ•—ï¼Œç›´æ¥é˜»æ–·æ‰€æœ‰æ“ä½œ
  if (connectionError) {
    return (
        <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-6 text-center font-sans">
            <div className="bg-rose-900/20 p-6 rounded-full mb-6 border border-rose-500/30 animate-pulse">
                <WifiOff size={48} className="text-rose-500" />
            </div>
            <h2 className="text-2xl font-bold text-slate-200 mb-3">é€£ç·šå¤±æ•—</h2>
            <p className="text-slate-400 mb-8 max-w-xs mx-auto leading-relaxed">
                ç„¡æ³•å–å¾—è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚
            </p>
            <div className="bg-slate-900 border border-slate-800 rounded-lg px-6 py-3 text-sm text-slate-500">
                è«‹é‡æ–°é–‹å•Ÿæ­¤ç¶²é 
            </div>
        </div>
    );
  }

  // Loading Animation
  if (loading && !isLoggedIn) {
      return (
        <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center relative overflow-hidden">
            <style>{`
                @keyframes flyHeart {
                    0% { left: -10%; opacity: 0; transform: translateY(0) scale(0.5) rotate(-10deg); }
                    10% { opacity: 1; }
                    50% { transform: translateY(-20px) scale(1.2) rotate(10deg); }
                    90% { opacity: 1; }
                    100% { left: 110%; opacity: 0; transform: translateY(0) scale(0.5) rotate(-10deg); }
                }
                .heart-flight {
                    position: absolute;
                    animation: flyHeart 2s linear infinite;
                    font-size: 3rem;
                    top: 45%;
                }
            `}</style>
            <div className="heart-flight">â¤ï¸</div>
            <div className="heart-flight" style={{ animationDelay: '0.8s', top: '55%', fontSize: '2rem' }}>ğŸ’Œ</div>
            <div className="z-10 mt-32 text-slate-400 font-medium tracking-widest animate-pulse">æ­£åœ¨ç‚ºæ‚¨ç‰½ç·šä¸­...</div>
        </div>
      );
  }

  // Login Screen
  if (!isLoggedIn) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans text-slate-100">
        <div className="w-full max-w-md bg-slate-800 rounded-2xl shadow-xl overflow-hidden border border-slate-700">
          <div className="bg-indigo-600 p-8 text-center relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
            <div className="relative z-10 flex flex-col items-center">
              <div className="bg-indigo-500 p-3 rounded-full mb-4 shadow-lg shadow-indigo-900/50">
                <Moon size={40} className="text-yellow-300" />
              </div>
              <h1 className="text-3xl font-bold text-white tracking-wider">æœˆè€ä¿¡ç®±</h1>
              <p className="text-indigo-200 mt-2 text-sm">é€£çµç·£åˆ†ï¼Œå‚³éå¿ƒæ„</p>
            </div>
          </div>
          
          <form onSubmit={handleLogin} className="p-8 space-y-6">
            <div className="space-y-2">
              <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider">ä½¿ç”¨è€… ID</label>
              <div className="relative">
                <User className="absolute left-3 top-3 text-slate-500" size={18} />
                <input 
                  type="text" 
                  value={user.id}
                  onChange={(e) => setUser({...user, id: e.target.value})}
                  placeholder="è«‹è¼¸å…¥æ‚¨çš„ ID"
                  className="w-full bg-slate-900 border border-slate-700 text-white pl-10 pr-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all placeholder-slate-600"
                />
              </div>
            </div>

            <div className="space-y-2">
              <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider">ç›®å‰éšæ®µ (Stage)</label>
              <div className="relative">
                <RefreshCw className="absolute left-3 top-3 text-slate-500" size={18} />
                <input 
                  type="number" 
                  value={user.stage}
                  onChange={(e) => setUser({...user, stage: e.target.value})}
                  placeholder="1"
                  min="1"
                  max="7"
                  className="w-full bg-slate-900 border border-slate-700 text-white pl-10 pr-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all placeholder-slate-600"
                />
              </div>
            </div>

            <button 
              type="submit" 
              disabled={loading}
              className="w-full bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-900/40 transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              {loading ? (
                <span className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
              ) : (
                <>
                  <LogIn size={20} />
                  é€²å…¥ä¿¡ç®±
                </>
              )}
            </button>
          </form>
        </div>
        {notification && <Toast notification={notification} />}
      </div>
    );
  }

  // Main Logged In View
  return (
    <div className="min-h-screen bg-slate-950 text-slate-200 font-sans pb-10">
      {/* Header */}
      <header className="bg-slate-900/80 backdrop-blur-md sticky top-0 z-40 border-b border-slate-800 shadow-md">
        <div className="max-w-2xl mx-auto px-4 py-4 flex justify-between items-center">
          <div className="flex items-center gap-3" onClick={() => setIsLoggedIn(false)} role="button">
            <div className="bg-indigo-600 p-2 rounded-lg">
              <Moon size={20} className="text-yellow-300" />
            </div>
            <h1 className="font-bold text-lg hidden sm:block">æœˆè€ä¿¡ç®±</h1>
          </div>
          
          {/* Header User Info */}
          <div className="flex items-center gap-2 bg-slate-800/80 py-1.5 px-4 rounded-full border border-slate-700/50">
            <span className="font-bold text-slate-200 text-lg">{data?.me?.nickname}</span>
            <span className="text-xl leading-none" role="img" aria-label="animal">
                {data?.me?.animal}
            </span>
          </div>
        </div>
      </header>

      <main className="max-w-2xl mx-auto px-4 py-6 space-y-6">
        
        {/* Write Letter Section */}
        <section className="bg-slate-900 rounded-2xl shadow-xl border border-slate-800 overflow-hidden relative">
          <div className="bg-gradient-to-r from-pink-900/20 to-purple-900/20 px-6 py-4 border-b border-slate-800 flex items-center gap-2">
            <Send size={18} className="text-pink-400" />
            <h2 className="font-bold text-lg text-pink-100">å‚³éå¿ƒæ„</h2>
          </div>
          
          <div className="p-6">
            {data?.hasSent ? (
              <div className="text-center py-8">
                <div className="bg-green-500/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                  <CheckCircle size={32} className="text-green-400" />
                </div>
                <h3 className="text-xl font-bold text-white mb-2">ä¿¡ä»¶å·²å¯„å‡º</h3>
                <p className="text-slate-400">æœˆè€æ­£åœ¨ç‚ºæ‚¨å‚³éé€™ä»½å¿ƒæ„...</p>
              </div>
            ) : (
              <LetterForm 
                targets={data?.targets || []} 
                sentences={data?.sentences || []} 
                onSend={handleSend}
                loading={loading}
              />
            )}
          </div>
        </section>

        {/* Inbox Button (Collapsible) */}
        <button 
          onClick={handleOpenInbox}
          className="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl p-4 flex items-center justify-between group transition-all shadow-lg active:scale-95"
        >
          <div className="flex items-center gap-3">
            <div className="bg-indigo-900/50 p-2.5 rounded-lg text-indigo-300">
              <Mail size={24} />
            </div>
            <div className="text-left">
              <div className="font-bold text-lg text-indigo-100">æˆ‘çš„æ”¶ä»¶åŒ£</div>
              <div className="text-xs text-slate-400">é»æ“ŠæŸ¥çœ‹æ”¶åˆ°çš„ä¿¡ä»¶</div>
            </div>
          </div>
          
          <div className="flex items-center gap-3">
            {/* New Mail Badge (Based on LocalStorage logic) */}
            {newMailCount > 0 && (
              <div className="bg-rose-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse shadow-lg shadow-rose-900/50 flex items-center gap-1">
                <span className="w-1.5 h-1.5 bg-white rounded-full"></span>
                æ–°ä¿¡ä»¶
              </div>
            )}
            <ChevronRight className="text-slate-500 group-hover:text-white transition-colors" />
          </div>
        </button>

      </main>

      {/* Inbox Modal / Overlay */}
      {showInbox && (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-slate-950/90 backdrop-blur-sm p-0 sm:p-4 animate-fade-in">
          <div className="bg-slate-900 w-full max-w-lg h-[85vh] sm:h-[600px] rounded-t-2xl sm:rounded-2xl border border-slate-800 shadow-2xl flex flex-col animate-slide-up">
            
            {/* Modal Header */}
            <div className="flex items-center justify-between p-4 border-b border-slate-800 bg-slate-900/50">
              <div className="flex items-center gap-2">
                <Mail size={20} className="text-indigo-400" />
                <h2 className="font-bold text-lg text-white">æ”¶ä»¶åŒ£</h2>
                <span className="bg-slate-800 text-slate-400 text-xs px-2 py-0.5 rounded-full border border-slate-700">
                  {data?.inbox?.length || 0}
                </span>
              </div>
              <button 
                onClick={() => setShowInbox(false)}
                className="p-2 bg-slate-800 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors"
              >
                <X size={20} />
              </button>
            </div>

            {/* Modal Body (Scrollable) */}
            <div className="flex-1 overflow-y-auto p-4 space-y-3">
              {data?.inbox?.length > 0 ? (
                data.inbox.map((mail, idx) => (
                  <MailItem key={idx} mail={mail} />
                ))
              ) : (
                <div className="h-full flex flex-col items-center justify-center text-slate-500 space-y-4">
                  <div className="bg-slate-800/50 p-6 rounded-full">
                    <Mail size={48} className="opacity-20" />
                  </div>
                  <p>ç›®å‰æ²’æœ‰ä¿¡ä»¶</p>
                </div>
              )}
            </div>
            
            {/* Modal Footer (Optional close button for clarity) */}
            <div className="p-4 border-t border-slate-800 sm:hidden">
                <button 
                    onClick={() => setShowInbox(false)}
                    className="w-full bg-slate-800 text-white font-medium py-3 rounded-xl active:scale-95 transition-transform"
                >
                    é—œé–‰
                </button>
            </div>
          </div>
        </div>
      )}

      {notification && <Toast notification={notification} />}
    </div>
  );
};

// --- Sub-components ---

const LetterForm = ({ targets, sentences, onSend, loading }) => {
  const [targetId, setTargetId] = useState("");
  const [sentence, setSentence] = useState("");
  const [sendMode, setSendMode] = useState('nickname'); 

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!targetId || !sentence) return;
    onSend(targetId, sentence);
  };

  const displayTargets = useMemo(() => {
    if (sendMode === 'nickname') {
      return targets;
    } else {
      const shuffled = [...targets];
      return shuffled.sort(() => Math.random() - 0.5);
    }
  }, [targets, sendMode]);

  return (
    <form onSubmit={handleSubmit} className="space-y-5">
      
      <div className="space-y-2">
        <label className="text-sm font-medium text-slate-400 block">æ”¶ä»¶å°è±¡é¡å‹</label>
        <div className="flex bg-slate-950 p-1 rounded-xl border border-slate-800">
          <button 
            type="button"
            className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-bold transition-all ${sendMode === 'nickname' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}
            onClick={() => {
                setSendMode('nickname');
                setTargetId('');
            }}
          >
            <Users size={16} />
            æŒ‡å®šæš±ç¨±
          </button>
          <button 
            type="button"
             className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-bold transition-all ${sendMode === 'animal' ? 'bg-pink-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}
            onClick={() => {
                setSendMode('animal');
                setTargetId('');
            }}
          >
            <Cat size={16} />
            å›ä¿¡çµ¦å‹•ç‰©
          </button>
        </div>
      </div>

      <div className="space-y-2 animate-fade-in">
        <label className="text-sm font-medium text-slate-400 block">
            {sendMode === 'nickname' ? 'é¸æ“‡å°è±¡æš±ç¨±' : 'é¸æ“‡å°æ–¹ä»£è¡¨å‹•ç‰©'}
        </label>
        <div className="relative">
            <select 
            value={targetId}
            onChange={(e) => setTargetId(e.target.value)}
            className="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-slate-200 focus:outline-none focus:ring-2 focus:ring-pink-500 appearance-none pl-10"
            >
            <option value="">-- è«‹é¸æ“‡ --</option>
            {displayTargets.map(t => (
                <option key={t.id} value={t.id}>
                    {sendMode === 'nickname' ? t.nickname : `${t.animal} (èº«åˆ†æœªçŸ¥)`}
                </option>
            ))}
            </select>
            <div className="absolute left-3 top-3.5 pointer-events-none text-slate-500">
                {sendMode === 'nickname' ? <User size={18} /> : <span className="text-lg leading-none">ğŸ¾</span>}
            </div>
        </div>
        {sendMode === 'animal' && (
            <p className="text-xs text-slate-500 mt-1 pl-1">
                * å‹•ç‰©åˆ—è¡¨å·²éš¨æ©Ÿæ’åºï¼Œç„¡æ³•å°æ‡‰åˆ°æš±ç¨±é †åº
            </p>
        )}
      </div>

      <div className="space-y-2">
        <label className="text-sm font-medium text-slate-400 block">é¸æ“‡é‡‘å¥</label>
        <select 
          value={sentence}
          onChange={(e) => setSentence(e.target.value)}
          className="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-slate-200 focus:outline-none focus:ring-2 focus:ring-pink-500 appearance-none"
        >
          <option value="">-- è«‹é¸æ“‡ --</option>
          {sentences.map((s, i) => (
            <option key={i} value={s}>{s}</option>
          ))}
        </select>
      </div>

      <button 
        type="submit"
        disabled={loading || !targetId || !sentence}
        className="w-full mt-4 bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-500 hover:to-rose-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-pink-900/30 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
      >
        {loading ? (
          <span className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
        ) : (
          <>
            <Heart size={18} fill="currentColor" />
            ç¢ºèªå¯„å‡º
          </>
        )}
      </button>
    </form>
  );
};

const MailItem = ({ mail }) => {
  return (
    <div className={`bg-slate-800 border border-slate-700 rounded-xl p-4 relative transition-colors`}>
      {/* Sender Header - simplified as requested */}
      <div className="flex items-center gap-2 mb-2">
        <span className="text-2xl leading-none">{mail.senderAnimal}</span>
        <div className="flex flex-col">
          <div className="text-xs text-slate-400 font-semibold uppercase tracking-wider">
            ç¬¬ {mail.stage} é—œä¿¡ä»¶
          </div>
          <div className="text-sm font-bold text-indigo-200">
             ä¾†è‡ª {mail.senderAnimal}
          </div>
        </div>
      </div>
      
      {/* Content */}
      <div className="bg-slate-900/50 rounded-lg p-3 text-slate-200 text-sm leading-relaxed border border-slate-800/50">
        {mail.content}
      </div>
    </div>
  );
};

const Toast = ({ notification }) => {
  const bgColor = notification.type === 'error' ? 'bg-red-500' : 
                  notification.type === 'warning' ? 'bg-amber-500' : 'bg-green-500';
  const Icon = notification.type === 'error' ? AlertCircle : 
               notification.type === 'warning' ? AlertCircle : CheckCircle;

  return (
    <div className={`fixed bottom-6 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-3 animate-bounce-in z-[60] min-w-[300px] justify-center`}>
      <Icon size={20} />
      <span className="font-medium">{notification.message}</span>
    </div>
  );
};

export default App;
